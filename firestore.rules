rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user has @kab.ac.ug email
    function isKabaleStudent() {
      return request.auth != null && 
             request.auth.token.email.matches('.*@kab[.]ac[.]ug$');
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.admin == true;
    }
    
    // Helper function to check if user has already voted
    function hasNotVoted() {
      return !exists(/databases/$(database)/documents/voters/$(request.auth.uid));
    }
    
    // Helper function to check if user account is active
    function isActiveUser(userId) {
      let userDoc = get(/databases/$(database)/documents/users/$(userId));
      return userDoc.data.accountStatus == 'active';
    }
    
    // ============================================
    // USERS COLLECTION - Student Profiles
    // ============================================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if request.auth.uid == userId;
      
      // Users can create their own profile during signup
      allow create: if request.auth.uid == userId &&
                      isKabaleStudent() &&
                      request.resource.data.keys().hasAll(['uid', 'email', 'fullName', 'course', 'yearOfStudy']) &&
                      request.resource.data.email == request.auth.token.email;
      
      // Users can update only their emailVerified status (done by system)
      allow update: if request.auth.uid == userId &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['emailVerified', 'verifiedAt']);
      
      // Users cannot delete their profile
      allow delete: if false;
      
      // Admins can read all profiles
      allow read: if isAdmin();
      
      // Admins can update account status (suspend, flag accounts)
      allow update: if isAdmin();
      
      // Admins can delete user profiles
      allow delete: if isAdmin();
    }
    
    // ============================================
    // VOTERS COLLECTION - Tracks who has voted
    // ============================================
    match /voters/{userId} {
      // Users can only create their own voter record once
      allow create: if request.auth.uid == userId && 
                      isKabaleStudent() && 
                      hasNotVoted() &&
                      request.auth.token.email_verified == true &&
                      isActiveUser(userId);
      
      // Users can read their own voting status
      allow read: if request.auth.uid == userId || isAdmin();
      
      // Admins can delete voter records for database clearing
      allow delete: if isAdmin();
      
      // No updates allowed (one vote per user forever)
      allow update: if false;
    }
    
    // ============================================
    // VOTES COLLECTION - Stores actual vote counts
    // ============================================
    match /votes/{position} {
      // Authenticated, verified Kabale students can read and write
      allow read: if isKabaleStudent() && 
                    request.auth.token.email_verified == true;
      
      allow create, update: if isKabaleStudent() && 
                              request.auth.token.email_verified == true &&
                              isActiveUser(request.auth.uid);
      
      // Admins can read everything
      allow read: if isAdmin();
      
      // Admins can delete votes for database clearing
      allow delete: if isAdmin();
    }
    
    // ============================================
    // REPORTS COLLECTION - For suspicious accounts
    // ============================================
    match /reports/{reportId} {
      // Any verified user can create a report
      allow create: if isKabaleStudent() &&
                      request.auth.token.email_verified == true &&
                      request.resource.data.keys().hasAll(['reportedEmail', 'reason', 'reportedBy', 'reportedAt']) &&
                      request.resource.data.reportedBy == request.auth.token.email;
      
      // Users cannot read reports
      allow read: if false;
      
      // Only admins can read, update, and delete reports
      allow read, update, delete: if isAdmin();
    }
    
    // ============================================
    // ADMIN COLLECTION - Stores admin emails
    // ============================================
    match /admins/{email} {
      allow read, write: if isAdmin();
    }
    
    // ============================================
    // CANDIDATES COLLECTION (if you have one)
    // ============================================
    match /candidates/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // ============================================
    // POSITIONS COLLECTION (if you have one)
    // ============================================
    match /positions/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}